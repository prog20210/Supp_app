<@Page Language="C#">
    @using System.Web.UI.HtmlControls;

    @using System;
    @using System.Collections.Generic;
    @using System.Linq;
    @using System.Web;
    @using System.Web.UI;
    @using System.Web.UI.WebControls;
    @using System.Configuration;
    @using System.Data.SqlClient;
    @using Npgsql;
    @using Npgsql.EntityFrameworkCore.PostgreSQL.Design;
    @using System.Configuration;
    @using System.Web.UI.HtmlControls;
    @using System.Data;
    @using System.Web.Mvc.Html;
    @using ClosedXML
    @using Aspose.Html
    

    @{


        Layout = null;
        int i;
        int n = 0;
        string html;
        int nz = 0;
        string dat = "";
        string year;
        string[] dt;
        string[] tim;
        string t1;
        StringWriter sw = new StringWriter();
        DateTime dt1;
        string[] podp = new String[1];
        int t3 = 0;


        dt1 = DateTime.Now;

        t1 = dt1.ToString();

        tim = t1.Split(' ');

        dat = dt1.ToShortDateString();


        for (i = 1; i < 60; i++)
        {
            n = i;

        }
        int t = 0;
        int j = 3;

        var tab1 = new HtmlTable();


        ConnectionStringSettings constr;
        constr = ConfigurationManager.ConnectionStrings["con"];


        NpgsqlConnection con = new NpgsqlConnection();


        con.ConnectionString = constr.ToString();

        //"Server = 127.0.0.1; Port = 5433; Database = sup; User Id = postgres; Password =12345";



        con.Open();
        int num;
        int numbn;
        NpgsqlCommand com = con.CreateCommand();
        com.CommandText = "select * from req";

        try
        {

            // 

            com.CommandText = "select COUNT(*) from req";

            // получить текущее количество столбцов в таблице из БД
            int nzap = Convert.ToInt16(com.ExecuteScalar());


            com.CommandText = "select * from req";

            NpgsqlDataReader rd = com.ExecuteReader();





            // Доработать цикл чтения и заполнения таблицы
            if (rd.HasRows)
            {



                while (rd.Read())
                {



                }
            }

            rd.Close();


            // создаем таблицу динамически. Дописать процедуру создания. Разобраться почему зависало 

            using (HTMLDocument doc = new HTMLDocument())
            {
                var body = doc.Body;

                var cols = 6;
                var rows = nz;

                /// заголовок таблицы. Получить  


                ////

                var tab2 = doc.GetElementsByTagName("html").First();
                var tbody = doc.CreateElement("tbody");
                tab2.AppendChild(tbody);


                var tr = doc.CreateElement("tr");
                tbody.AppendChild(tr);

                // продолжить писать шапку таблицы. Вставка ячеек

                var isFirstRowHeader = true;


                if (isFirstRowHeader)
                {

                    // неправильно обрабатывается запрос посмотреть 

                    NpgsqlCommand com1 = con.CreateCommand();



                    NpgsqlConnection con1 = new NpgsqlConnection();


                    con1.ConnectionString = constr.ToString();

                    con1.Open();

                    com1.CommandText = "select count(zagl) from otcols";


                    string namcol;

                    int nzap2 =  Convert.ToInt32(com1.ExecuteScalar());

                    NpgsqlCommand com2 = con.CreateCommand();

                    com2.CommandText = "select zagl from otcols order by id asc";


                    NpgsqlDataReader rd2 = com2.ExecuteReader();

                    if (rd2.HasRows)
                    {


                        t3 = 0;
                        string[] namcol2=new string[2];

                        int length = nzap2;

                        Array.Resize<string>(ref namcol2, length);


                        string tt = "";

                        for (t3 = 0; t3 <= nzap2-1; t3++)


                        {
                          // tt =rd2[0].

                             tr = doc.CreateElement("tr");
                            tbody.AppendChild(tr);

                            var th = doc.CreateElement("th");




                            var title = doc.CreateTextNode(namcol2[t3]);
                            th.AppendChild(title);
                            tr.AppendChild(th);

                       
                            rd2.NextResult();

                        }

                        rd2.Close();





                    }









                }



            }






            /// инициализация читалки и чтение из базы заголовков таблицы 




            // Получить элемент таблицы. Если переменная пустая - NULL, создать таблицу





            //////////////////////////////////////

















            // Создание столбцов заголовков таблицы 
            //             for (int k = 1; j < cols + 1; k++)
            //         {


            // Создание заголовков  в таблице



            //         }






        }

        catch
          {

        }




        using (sw)
        {




        }


    }



    <body>
        <div>
            <link rel="stylesheet" href="main.css">

            <h2 align="center">Список обращений на @dat г. </h2>


         

            <table name="html" class="table table-bordered  table-hover">
                <thead>
                <td>
                    <p align="center"> Дата </p>

                </td>
                
                <td>
                    <p align="center"> Время </p>
                </td>

                <td>
                    <p align="center"> Год </p>
                </td>

                <td>
                    <p align="center"> ФИО</p>
                </td>
                
                <td>
                    <p align="center"> Подразделение</p>
                </td>

                <td>
                    <p align="center"> Краткое описание</p>
                </td>


                <td>
                    <p align="center"> Статус обращения </p>


                </td>
                </thead>

                <tbody>



                    @{
                        //добавление в тело таблицы

                        var document = new HTMLDocument();
                        NpgsqlCommand com3 = con.CreateCommand();



                        NpgsqlConnection con3 = new NpgsqlConnection();


                        con3.ConnectionString = constr.ToString();

                        con3.Open();


                        com3.CommandText = "select  * from req";
                       // NpgsqlDataReader rd3 = com3.ExecuteReader();
                        string st;
                    }

